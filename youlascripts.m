clear;close all;clc;
s = tf('s');

% Ps = [-0.6408, 0.37, 0.6408, -0.37; -0.37, -0.6408, 0.37, 0.6408; 0.002*((s+0.1)^2), 0.002*((s+0.1)^2), 0.002*((s+0.1)^2), 0.002*((s+0.1)^2); -0.25*((s+0.1)^2), 0.25*((s+0.1)^2), -0.25*((s+0.1)^2), 0.25*((s+0.1)^2)]; 
% Gps = P/((s+0.1)^4);

P = [-0.6408, 0.37, 0.6408, -0.37; -0.37, -0.6408, 0.37, 0.6408; 0.002*(s^2), 0.002*(s^2), 0.002*(s^2), 0.002*(s^2); -0.25*(s^2), 0.25*(s^2), -0.25*(s^2), 0.25*(s^2)]; 
Gp = P/(s^4);

Gpss = ss(Gp);
[Ag,Bg,Cg,Dg] = ssdata(Gpss);
[Ag,Bg,Cg,Dg] = minreal(Ag,Bg,Cg,Dg);

Ul = [0, 1250/801, 0, 0; 16020000/3422029, 9250000/3422029, 0, 0; 0, (s+0.1)^2/16000, -2527/160000, -677/20000000; (s+0.1)^2/4000, (37*(s+0.1)^2)/256320, -3422029/64080000, 3422029/8010000000];
Ur = [0, 0, 0, -8010000000/3422029; 0, 0, -10000000/801, 4625000000/3422029; 0, 1/4, 0, -8010000000/3422029; 1, -925/6408, -10000000/801, 4625000000/3422029];
 
Mp = [1/(s+0.1)^4 0 0 0; 0 1/(s+0.1)^4 0 0; 0 0 1/(s+0.1)^2 0; 0 0 0 1/(s+0.1)^2];


Y1 = (s^4)/((s+1)^4);
Y2 = (s^4)/((s+1)^4);
Y3 = (s^2)/((s+1)^4);
Y4 = (s^2)/((s+1)^4);


My = [Y1 0 0 0; 0 Y2 0 0; 0 0 Y3 0; 0 0 0 Y4];

I = eye(4);

Y = minreal(Ur*My*Ul);
Ty = minreal(Gp*Y); 
Sy = minreal(eye(4)-Ty);

A = inv(I - My*Mp);
 
Gc = Ur*A*My*Ul;

K = ss(minreal(Gc));

save('youlagains.mat','Ag','Bg','K')

disp(K);

figure(1)
sigma(Sy)
hold on
sigma(Ty)
sigma(Y)
hold off
legend('Sy','Ty','Y')
grid

figure(2)
step(Y);
title('Actuator Responses to All 4 Inputs')
grid

figure(3)
step(Ty)
title('Output Responses to All 4 Inputs')
grid