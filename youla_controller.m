clc; 
close all;

s = tf('s');
P = [-0.6408, 0.37, 0.6408, -0.37; -0.37, -0.6408, 0.37, 0.6408; 0.002*((s+0.1)^2), 0.002*((s+0.1)^2), 0.002*((s+0.1)^2), 0.002*((s+0.1)^2); -0.25*((s+0.1)^2), 0.25*((s+0.1)^2), -0.25*((s+0.1)^2), 0.25*((s+0.1)^2)];
Gp = P/((s+0.1)^4);

Ul = [0, 1250/801, 0, 0; 16020000/3422029, 9250000/3422029, 0, 0; 0, (s^2)/16000 + s/80000 + 1/1600000, -2527/160000, -677/20000000; (s^2)/4000 + s/20000 + 1/400000, (37*(s^2))/256320 + (37*s)/1281600 + 37/25632000, -3422029/64080000, 3422029/8010000000];
Ur = [0, 0, 0, -8010000000/3422029; 0, 0, -10000000/801, 4625000000/3422029; 0, 1/4, 0, -8010000000/3422029; 1, -925/6408, -10000000/801,  4625000000/3422029];

Mp = [1/((s+0.1)^4) 0 0 0; 0 1/((s+0.1)^4) 0 0; 0 0 1/((s+0.1)^2) 0; 0 0 0 1/((s+0.1)^2)];

Y1 = ((s+0.1)^4)/((s+1)^4);
Y2 = ((s+0.1)^4)/((s+1)^4);
Y3 = ((s+0.1)^2)/((s+1)^4);
Y4 = ((s+0.1)^2)/((s+1)^4);

My = [Y1 0 0 0; 0 Y2 0 0; 0 0 Y3 0; 0 0 0 Y4];

I = eye(4);

Y = minreal(Ur*My*Ul);
Ty = minreal(Gp*Y);
Sy = minreal(I-Ty);

Gc = Ur*(inv(I - My*Mp))*My*Ul;

[Ag,Bg,Cg,Dg] = ssdata(Gc);
[Ag,Bg,Cg,Dg] = minreal(Ag,Bg,Cg,Dg);

K = ss(minreal(Gc));

save('youlagains.mat','Ag','Bg','K')

disp(K);


w={10^-4,10^4};
figure(1)
sigma(Sy,w)
hold on
sigma(Ty,w)
sigma(Y,w)
hold off
legend('Sy','Ty','Y')
grid
 
t = 20;
figure(2)
step(Ty,t)
title('Output Responses to All 4 Inputs')
grid